{% extends 'base.html' %}

{% block title %}Profile Detail{% endblock %}

{% block content %}
<div class="animate__animated animate__fadeIn">
    <div class="row mb-4">
        <div class="col-12">
            <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-light mb-3">
                <i class="bi bi-arrow-left"></i> Back to Admin Dashboard
            </a>
            <h1 class="text-white">
                <i class="bi bi-person-badge"></i> Profile: {{ profile.metadata.label }}
            </h1>
            <div class="mt-3">
                <a href="{% url 'update_profile' profile.id %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit Profile
                </a>
                <button class="btn btn-info" onclick="exportSeed('{{ profile.id }}')">
                    <i class="bi bi-download"></i> Export Seed
                </button>
                <form method="post" action="{% url 'delete_profile' profile.id %}" class="d-inline" 
                      onsubmit="return confirm('Are you sure you want to delete this profile? This action cannot be undone.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Profile
                    </button>
                </form>
            </div>
        </div>
    </div>

<script>
function exportSeed(profileId) {
    fetch(`/manage/profile/${profileId}/export/`)
        .then(response => response.json())
        .then(data => {
            const modal = `
                <div class="modal fade" id="seedModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title">TOTP Seed Export</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle-fill"></i> 
                                    <strong>Warning:</strong> Keep this seed secret and secure!
                                </div>
                                <p><strong>Label:</strong> ${data.label}</p>
                                <p><strong>Issuer:</strong> ${data.issuer}</p>
                                <p><strong>Seed:</strong></p>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="${data.seed}" id="seedValue" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copySeed()">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                </div>
                                <p class="mt-3"><strong>OTP URI:</strong></p>
                                <textarea class="form-control" rows="3" readonly>${data.otp_uri}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            const modalElement = new bootstrap.Modal(document.getElementById('seedModal'));
            modalElement.show();
            document.getElementById('seedModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        });
}

function copySeed() {
    const seedValue = document.getElementById('seedValue');
    seedValue.select();
    document.execCommand('copy');
    alert('Seed copied to clipboard!');
}

// QR Code Customization Functions
function updateQRPreview() {
    const fgColor = document.getElementById('fgColor').value.substring(1);
    const bgColor = document.getElementById('bgColor').value.substring(1);
    const boxSize = document.getElementById('boxSize').value;
    const border = document.getElementById('border').value;
    const sizePreset = document.getElementById('sizePreset').value;
    
    // Update text inputs
    document.getElementById('fgText').value = '#' + fgColor;
    document.getElementById('bgText').value = '#' + bgColor;
    
    // Update value displays
    document.getElementById('boxSizeValue').textContent = boxSize;
    document.getElementById('borderValue').textContent = border;
    
    // Show loading
    const preview = document.getElementById('qrPreview');
    const spinner = document.getElementById('loadingSpinnerDetail');
    spinner.classList.remove('d-none');
    preview.style.opacity = '0.5';
    
    // Build QR URL
    const profileId = '{{ profile.id }}';
    const qrUrl = `/qr/${profileId}/?fg=%23${fgColor}&bg=%23${bgColor}&box_size=${boxSize}&border=${border}`;
    const downloadUrl = `/qr/${profileId}/download/?fg=%23${fgColor}&bg=%23${bgColor}&size=${sizePreset}&box_size=${boxSize}&border=${border}`;
    
    // Update preview with delay for smooth UX
    setTimeout(() => {
        preview.src = qrUrl;
        preview.onload = () => {
            spinner.classList.add('d-none');
            preview.style.opacity = '1';
            preview.classList.remove('animate__zoomIn');
            void preview.offsetWidth;
            preview.classList.add('animate__zoomIn');
        };
        document.getElementById('downloadBtn').href = downloadUrl;
    }, 200);
}

function applyColorPreset(fg, bg) {
    document.getElementById('fgColor').value = fg;
    document.getElementById('bgColor').value = bg;
    updateQRPreview();
}

function resetDefaults() {
    document.getElementById('fgColor').value = '#000000';
    document.getElementById('bgColor').value = '#ffffff';
    document.getElementById('boxSize').value = 10;
    document.getElementById('border').value = 4;
    document.getElementById('sizePreset').value = 'medium';
    updateQRPreview();
}

// Sync text inputs with color pickers
document.getElementById('fgText')?.addEventListener('input', (e) => {
    const val = e.target.value;
    if (/^#[0-9A-F]{6}$/i.test(val)) {
        document.getElementById('fgColor').value = val;
        updateQRPreview();
    }
});

document.getElementById('bgText')?.addEventListener('input', (e) => {
    const val = e.target.value;
    if (/^#[0-9A-F]{6}$/i.test(val)) {
        document.getElementById('bgColor').value = val;
        updateQRPreview();
    }
});

// Event listeners
['fgColor', 'bgColor', 'boxSize', 'border', 'sizePreset'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', updateQRPreview);
});

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
    updateQRPreview();
});
</script>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Profile Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>User ID:</strong>
                        <p class="text-muted">{{ profile.user_id }}</p>
                    </div>
                    <div class="mb-3">
                        <strong>Label:</strong>
                        <p class="text-muted">{{ profile.metadata.label }}</p>
                    </div>
                    <div class="mb-3">
                        <strong>Issuer:</strong>
                        <p class="text-muted">{{ profile.metadata.issuer }}</p>
                    </div>
                    <div class="mb-3">
                        <strong>Algorithm:</strong>
                        <span class="badge bg-info">{{ profile.metadata.algorithm }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Digits:</strong>
                        <span class="badge bg-secondary">{{ profile.metadata.digits }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Period:</strong>
                        <span class="badge bg-secondary">{{ profile.metadata.period }}s</span>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-fill-exclamation"></i> Security Flags</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Status:</strong>
                        <span class="badge {% if profile.security_flags.revocation_state == 'Active' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ profile.security_flags.revocation_state }}
                        </span>
                    </div>
                    <div class="mb-3">
                        <strong>High Privilege:</strong>
                        {% if profile.security_flags.is_high_privilege %}
                        <i class="bi bi-check-circle-fill text-success"></i> Yes
                        {% else %}
                        <i class="bi bi-x-circle-fill text-danger"></i> No
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <strong>Private Profile:</strong>
                        {% if profile.security_flags.is_private %}
                        <i class="bi bi-check-circle-fill text-success"></i> Yes
                        {% else %}
                        <i class="bi bi-x-circle-fill text-danger"></i> No
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-award"></i> Kelley Attributes</h5>
                </div>
                <div class="card-body">
                    {% for key, value in profile.kelley_attributes.items %}
                    <div class="mb-2">
                        <strong>{{ key|title }}:</strong>
                        <span class="text-muted">{{ value }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- QR Code Customization Card -->
            <div class="card mb-4 shadow-lg border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0"><i class="bi bi-qr-code-scan"></i> QR Code Studio</h5>
                </div>
                <div class="card-body">
                    <!-- QR Code Preview -->
                    <div class="text-center mb-4">
                        <h6 class="text-primary mb-3"><i class="bi bi-eye-fill"></i> Live Preview</h6>
                        <div class="qr-preview-wrapper p-4 bg-light rounded-3 shadow-sm position-relative" style="min-height: 330px; display: flex; align-items: center; justify-content: center;">
                            <img id="qrPreview" src="{% url 'qr_code' profile.id %}?bg=ffffff&fg=000000&box_size=10&border=4" 
                                 alt="QR Code" class="img-fluid animate__animated animate__zoomIn" style="max-width: 280px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                            <div id="loadingSpinnerDetail" class="position-absolute top-50 start-50 translate-middle d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customization Controls -->
                    <h6 class="text-primary mb-3"><i class="bi bi-palette-fill"></i> Customization</h6>
                    
                    <!-- Color Selection -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold small">
                                <i class="bi bi-droplet-fill"></i> Foreground
                            </label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="bi bi-palette"></i></span>
                                <input type="color" id="fgColor" class="form-control form-control-color" value="#000000">
                                <input type="text" id="fgText" class="form-control" value="#000000" maxlength="7">
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold small">
                                <i class="bi bi-paint-bucket"></i> Background
                            </label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="bi bi-bucket"></i></span>
                                <input type="color" id="bgColor" class="form-control form-control-color" value="#ffffff">
                                <input type="text" id="bgText" class="form-control" value="#ffffff" maxlength="7">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Color Presets -->
                    <div class="mb-3">
                        <label class="form-label fw-bold small">
                            <i class="bi bi-stars"></i> Quick Presets
                        </label>
                        <div class="d-flex gap-1 flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-dark" onclick="applyColorPreset('#000000', '#ffffff')" title="Classic Black">
                                ‚ö´
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyColorPreset('#0d6efd', '#ffffff')" title="Blue">
                                üîµ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="applyColorPreset('#198754', '#ffffff')" title="Green">
                                üü¢
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="applyColorPreset('#dc3545', '#ffffff')" title="Red">
                                üî¥
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="applyColorPreset('#ffc107', '#000000')" title="Gold">
                                üü°
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="applyColorPreset('#0dcaf0', '#000000')" title="Cyan">
                                üîµ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="applyColorPreset('#6c757d', '#ffffff')" title="Gray">
                                ‚ö™
                            </button>
                        </div>
                    </div>
                    
                    <!-- Size Preset Dropdown -->
                    <div class="mb-3">
                        <label class="form-label fw-bold small">
                            <i class="bi bi-aspect-ratio-fill"></i> Size & Aspect Ratio
                        </label>
                        <select id="sizePreset" class="form-select form-select-sm">
                            <option value="small">üì± Small (256√ó256)</option>
                            <option value="medium" selected>üíª Medium (512√ó512)</option>
                            <option value="large">üñ•Ô∏è Large (1024√ó1024)</option>
                            <option value="1:1">‚¨ú Square 1:1 (800px)</option>
                            <option value="16:9">üì∫ Widescreen 16:9 (1920px)</option>
                            <option value="4:3">üìΩÔ∏è Standard 4:3 (1024px)</option>
                        </select>
                    </div>
                    
                    <!-- Advanced Sliders -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label small">
                                <i class="bi bi-grid-3x3"></i> Pixel Size: <span id="boxSizeValue" class="badge bg-primary">10</span>
                            </label>
                            <input type="range" id="boxSize" class="form-range" min="5" max="20" value="10">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">
                                <i class="bi bi-border-width"></i> Border: <span id="borderValue" class="badge bg-secondary">4</span>
                            </label>
                            <input type="range" id="border" class="form-range" min="0" max="10" value="4">
                        </div>
                    </div>
                    
                    <!-- Download Button -->
                    <div class="d-grid gap-2">
                        <a href="#" id="downloadBtn" class="btn btn-success">
                            <i class="bi bi-download"></i> Download Customized QR
                        </a>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetDefaults()">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Audit Logs</h5>
                </div>
                <div class="card-body">
                    {% if audit_logs %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event</th>
                                    <th>Actor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in audit_logs %}
                                <tr>
                                    <td class="small">{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if log.event_type == 'PROFILE_CREATED' %}bg-success
                                            {% elif log.event_type == 'VIEW_SEED' %}bg-warning
                                            {% elif log.event_type == 'PROFILE_MODIFIED' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ log.event_type }}
                                        </span>
                                    </td>
                                    <td class="small">{{ log.actor.user_id }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No audit logs found.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-journal-text"></i> Modification History</h5>
                </div>
                <div class="card-body">
                    {% if profile.history %}
                    <ul class="list-group list-group-flush">
                        {% for event in profile.history %}
                        <li class="list-group-item">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> {{ event.timestamp|date:"Y-m-d H:i:s" }}
                            </small>
                            <br>
                            <strong>Changes:</strong> {{ event.changes }}
                            <br>
                            <small><strong>By:</strong> {{ event.actor.user_id }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">No modification history.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
