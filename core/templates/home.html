{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="animate__animated animate__fadeIn">
    <div class="p-3 p-md-5 mb-4 text-white rounded-3" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
        <div class="container-fluid py-3 py-md-5">
            <h1 class="display-5 display-md-4 fw-bold animate__animated animate__fadeInDown">
                <i class="bi bi-shield-lock-fill"></i> <span class="d-none d-sm-inline">Kelley Token Validation System</span><span class="d-sm-none">KTVS</span>
            </h1>
            <p class="col-12 col-md-8 fs-5 fs-md-4 animate__animated animate__fadeInUp">
                A production-grade MFA management platform designed to enforce Kelley-Approved Notary protocols with enterprise-level security.
            </p>
            <div class="mt-3 mt-md-4 animate__animated animate__fadeInUp d-flex flex-column flex-sm-row gap-2" style="animation-delay: 0.3s;">
                {% if user.is_authenticated %}
                    <a class="btn btn-primary btn-lg w-100 w-sm-auto" href="{% url 'dashboard' %}">
                        <i class="bi bi-speedometer2"></i> Go to Dashboard
                    </a>
                {% else %}
                    <a class="btn btn-primary btn-lg w-100 w-sm-auto" href="{% url 'login' %}">
                        <i class="bi bi-box-arrow-in-right"></i> Login to Access
                    </a>
                    <a class="btn btn-success btn-lg w-100 w-sm-auto" href="{% url 'register' %}">
                        <i class="bi bi-person-plus"></i> Register Now
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row align-items-md-stretch mb-4">
        <div class="col-md-4 mb-3">
            <div class="h-100 p-4 text-white rounded-3 animate__animated animate__fadeInLeft" 
                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); backdrop-filter: blur(10px);">
                <div class="stat-icon">
                    <i class="bi bi-shield-fill-check"></i>
                </div>
                <h2><i class="bi bi-lock-fill"></i> Secure Architecture</h2>
                <p>Utilizing AES-256-GCM encryption and hardware security module integration for maximum protection of TOTP seeds.</p>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle-fill text-success"></i> End-to-end encryption</li>
                    <li><i class="bi bi-check-circle-fill text-success"></i> HSM integration ready</li>
                    <li><i class="bi bi-check-circle-fill text-success"></i> Secure key storage</li>
                </ul>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="h-100 p-4 rounded-3 animate__animated animate__fadeInUp" 
                 style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); animation-delay: 0.2s;">
                <div class="stat-icon text-primary">
                    <i class="bi bi-clipboard-check"></i>
                </div>
                <h2><i class="bi bi-award-fill text-warning"></i> Compliance Ready</h2>
                <p>Built to meet NIST SP 800-63B standards with comprehensive audit logging and immutable history tracking.</p>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle-fill text-success"></i> NIST SP 800-63B compliant</li>
                    <li><i class="bi bi-check-circle-fill text-success"></i> Immutable audit trails</li>
                    <li><i class="bi bi-check-circle-fill text-success"></i> Complete activity logging</li>
                </ul>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="h-100 p-4 text-white rounded-3 animate__animated animate__fadeInRight" 
                 style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); backdrop-filter: blur(10px); animation-delay: 0.3s;">
                <div class="stat-icon">
                    <i class="bi bi-lightning-charge-fill"></i>
                </div>
                <h2><i class="bi bi-rocket-takeoff-fill"></i> Enterprise Features</h2>
                <p>Advanced features designed for enterprise-level deployment with OAuth2 integration and role-based access control.</p>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle-fill text-white"></i> Google & GitHub OAuth</li>
                    <li><i class="bi bi-check-circle-fill text-white"></i> Role-based access</li>
                    <li><i class="bi bi-check-circle-fill text-white"></i> Multi-factor authentication</li>
                </ul>
            </div>
        </div>
    </div>

    {% if user.is_authenticated %}
    <div class="row mb-5 justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <div class="card-body p-4 p-md-5">
                    <div class="text-center mb-4">
                        <h2 class="mb-3 fw-bold"><i class="bi bi-qr-code text-primary"></i> Instant QR Generator</h2>
                        <p class="text-muted fs-5">Generate a secure QR code for any URL instantly.</p>
                    </div>
                    
                    <div class="input-group input-group-lg mb-4 shadow-sm rounded-pill overflow-hidden">
                        <span class="input-group-text border-0 bg-light ps-4"><i class="bi bi-link-45deg fs-4"></i></span>
                        <input type="url" id="qrUrlInput" class="form-control border-0 bg-light" placeholder="Paste your URL here (e.g., https://example.com)..." aria-label="URL Input">
                        <button class="btn btn-primary px-4 fw-bold" type="button" id="generateQrBtn">
                            Generate <i class="bi bi-magic ms-2"></i>
                        </button>
                    </div>
                    
                    <!-- Size Selection -->
                    <div class="row mb-4 justify-content-center">
                        <div class="col-md-8">
                            <label class="form-label fw-semibold"><i class="bi bi-aspect-ratio"></i> QR Code Size & Format:</label>
                            <select id="qrSizeSelect" class="form-select form-select-lg shadow-sm">
                                <option value="medium" selected>Standard (512x512) - General Use</option>
                                <option value="small">Small (256x256) - Mobile Optimized</option>
                                <option value="large">Large (1024x1024) - Desktop/Print</option>
                                <option value="16:9">Widescreen 16:9 - HD Displays</option>
                                <option value="mobile">Mobile Portrait - Smartphones</option>
                                <option value="ios">iOS Optimized - iPhone/iPad</option>
                                <option value="android">Android Optimized - Android Devices</option>
                                <option value="1:1">Square 1:1 - Instagram/Social</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="qrResult" class="mt-4 d-none animate__animated animate__zoomIn text-center">
                        <div class="p-4 border rounded bg-white d-inline-block shadow-sm">
                            <img id="generatedQrImage" src="" alt="Generated QR Code" class="img-fluid" style="max-width: 350px;">
                        </div>
                        <div class="mt-4">
                            <a id="downloadQrBtn" href="#" download="qrcode.png" class="btn btn-success btn-lg rounded-pill px-5 shadow">
                                <i class="bi bi-download me-2"></i> Download PNG
                            </a>
                        </div>
                        <p class="text-muted mt-3 small">
                            <i class="bi bi-info-circle"></i> Your QR code is ready! Right-click to save or use the download button above.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-stars"></i> Key Features</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h5><i class="bi bi-database-fill-lock text-primary"></i> Encrypted Storage</h5>
                            <p class="text-muted">All TOTP seeds are encrypted using industry-standard AES-256-GCM encryption before storage.</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h5><i class="bi bi-diagram-3-fill text-success"></i> MongoDB Integration</h5>
                            <p class="text-muted">High-performance MongoDB database for storing profiles, audit logs, and user data.</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h5><i class="bi bi-qr-code-scan text-info"></i> QR Code Generation</h5>
                            <p class="text-muted">Automatic QR code generation for easy setup with any TOTP-compatible authenticator app.</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h5><i class="bi bi-person-badge-fill text-warning"></i> Role Management</h5>
                            <p class="text-muted">Comprehensive role-based access control with admin dashboard for user management.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('generateQrBtn');
    const input = document.getElementById('qrUrlInput');
    const sizeSelect = document.getElementById('qrSizeSelect');
    const resultDiv = document.getElementById('qrResult');
    const img = document.getElementById('generatedQrImage');
    const downloadBtn = document.getElementById('downloadQrBtn');

    function generateQR() {
        const url = input.value.trim();
        if (!url) {
            input.classList.add('is-invalid');
            alert('Please enter a valid URL');
            return;
        }
        
        // Basic URL validation
        try {
            new URL(url);
        } catch (e) {
            input.classList.add('is-invalid');
            alert('Please enter a valid URL (e.g., https://example.com)');
            return;
        }
        
        input.classList.remove('is-invalid');
        
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

        const size = sizeSelect.value;

        fetch('{% url "generate_qr_url" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                url: url,
                size: size
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Generation failed');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // Create object URL for the image
            const imgUrl = URL.createObjectURL(blob);
            img.src = imgUrl;
            img.alt = 'QR Code for ' + url;
            downloadBtn.href = imgUrl;
            
            // Update download filename with timestamp
            const timestamp = new Date().toISOString().slice(0,10);
            downloadBtn.download = `qrcode_${timestamp}_${size}.png`;
            
            // Show result
            resultDiv.classList.remove('d-none');
            
            // Scroll to result
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to generate QR code: ' + error.message + '\n\nPlease check your URL and try again.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Generate <i class="bi bi-magic ms-2"></i>';
        });
    }

    btn.addEventListener('click', generateQR);
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            generateQR();
        }
    });
    
    // Clear invalid state when user starts typing
    input.addEventListener('input', function() {
        input.classList.remove('is-invalid');
    });
});
</script>
{% endblock %}

