{% extends 'base.html' %}

{% block title %}Pricing Plans{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-sm-3 px-md-4 animate__animated animate__fadeIn">
    <div class="text-center mb-4 mb-md-5">
        <h1 class="h2 h1-md fw-bold text-white mb-2 mb-md-3">
            <i class="bi bi-cash-coin"></i> Choose Your Plan
        </h1>
        <p class="text-white-50 small">Select the perfect plan for your needs</p>
    </div>

    <!-- Coupon Code Section -->
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-sm-10 col-md-8 col-lg-6">
            <div class="card shadow-lg">
                <div class="card-body text-center p-3 p-md-4">
                    <h5 class="h6"><i class="bi bi-ticket-perforated"></i> Have a Coupon Code?</h5>
                    <form method="post" action="{% url 'apply_coupon_code' %}" class="mt-3">
                        {% csrf_token %}
                        <div class="input-group input-group-sm input-group-md-lg flex-column flex-sm-row gap-2 gap-sm-0">
                            <input type="text" name="coupon_code" class="form-control" placeholder="Enter coupon code" required>
                            <select name="billing_cycle" class="form-select" style="max-width: 100%;">
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                            <button class="btn btn-success" type="submit">
                                <i class="bi bi-check-circle"></i> Apply
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Pricing Cards -->
    <div class="row g-3 g-md-4">
        <!-- FREE Plan -->
        <div class="col-12 col-md-4">
            <div class="card h-100 {% if current_plan == 'FREE' %}border-primary border-3{% endif %} animate__animated animate__fadeInLeft">
                <div class="card-header text-center {% if current_plan == 'FREE' %}bg-primary text-white{% else %}bg-light{% endif %} py-2 py-md-3">
                    <h3 class="mb-0 h5 h4-md">
                        <i class="bi bi-gift"></i> Free
                        {% if current_plan == 'FREE' %}
                        <span class="badge bg-white text-primary ms-2">Current</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body d-flex flex-column p-3 p-md-4">
                    <div class="text-center mb-3 mb-md-4">
                        <h1 class="display-5 display-4-md fw-bold">$0</h1>
                        <p class="text-muted small mb-0">Forever Free</p>
                    </div>
                    <ul class="list-unstyled mb-3 mb-md-4 small">
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>{{ plans.FREE.qr_limit }}</strong> QR Codes</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>{{ plans.FREE.storage_mb }}MB</strong> Storage</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>{{ plans.FREE.api_calls_per_day }}</strong> API Calls/Day</li>
                        <li class="mb-2"><i class="bi bi-x-circle-fill text-muted"></i> Priority Support</li>
                        <li class="mb-2"><i class="bi bi-x-circle-fill text-muted"></i> Custom Branding</li>
                        <li class="mb-2"><i class="bi bi-x-circle-fill text-muted"></i> Advanced Analytics</li>
                    </ul>
                    <div class="mt-auto">
                        {% if current_plan != 'FREE' %}
                        <form method="post" action="{% url 'cancel_subscription' %}">
                            {% csrf_token %}
                            <input type="hidden" name="immediate" value="true">
                            <button type="submit" class="btn btn-outline-secondary w-100">Downgrade</button>
                        </form>
                        {% else %}
                        <button class="btn btn-primary w-100" disabled>Current Plan</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- PRO Plan -->
        <div class="col-md-4">
            <div class="card h-100 {% if current_plan == 'PRO' %}border-success border-3{% endif %} shadow-lg animate__animated animate__fadeInUp" style="animation-delay: 0.1s; transform: scale(1.05);">
                <div class="ribbon">
                    <span><i class="bi bi-star-fill"></i> POPULAR</span>
                </div>
                <div class="card-header text-center {% if current_plan == 'PRO' %}bg-success text-white{% else %}bg-gradient{% endif %}" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);">
                    <h3 class="mb-0 text-white">
                        <i class="bi bi-rocket-takeoff"></i> Pro
                        {% if current_plan == 'PRO' %}
                        <span class="badge bg-white text-success ms-2">Current</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="text-center mb-4">
                        <h1 class="display-3 fw-bold" id="pro-price">${{ plans.PRO.price_monthly }}</h1>
                        <p class="text-muted" id="pro-period">per month</p>
                        <p class="small text-success"><i class="bi bi-piggy-bank"></i> Save 17% with yearly billing</p>
                    </div>
                    <ul class="list-unstyled mb-4">
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>{{ plans.PRO.qr_limit }}</strong> QR Codes</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>{{ plans.PRO.storage_mb }}MB</strong> Storage</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>{{ plans.PRO.api_calls_per_day|floatformat:0 }}</strong> API Calls/Day</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Priority Support</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Custom Branding</li>
                        <li class="mb-2"><i class="bi bi-x-circle-fill text-muted"></i> Advanced Analytics</li>
                    </ul>
                    <div class="mt-auto">
                        {% if current_plan == 'FREE' %}
                        <form method="post" action="{% url 'upgrade_plan' %}" id="pro-form">
                            {% csrf_token %}
                            <input type="hidden" name="plan_type" value="PRO">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Billing Cycle</label>
                                <select name="billing_cycle" class="form-select" id="pro-billing-select" onchange="updateProPrice(this.value)">
                                    <option value="monthly" selected>Monthly - ${{ plans.PRO.price_monthly }}/mo</option>
                                    <option value="yearly">Yearly - ${{ plans.PRO.price_yearly }}/yr (Save 17%)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100 btn-lg">
                                <i class="bi bi-cart-check"></i> Proceed to Payment
                            </button>
                            <small class="d-block text-center text-muted mt-2">
                                <i class="bi bi-shield-check"></i> Secure checkout
                            </small>
                        </form>
                        {% elif current_plan == 'PRO' %}
                        <button class="btn btn-success w-100" disabled>Current Plan</button>
                        {% else %}
                        <button class="btn btn-outline-secondary w-100" disabled>Downgrade to Pro</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ENTERPRISE Plan -->
        <div class="col-md-4">
            <div class="card h-100 {% if current_plan == 'ENTERPRISE' %}border-warning border-3{% endif %} animate__animated animate__fadeInRight" style="animation-delay: 0.2s;">
                <div class="card-header text-center {% if current_plan == 'ENTERPRISE' %}bg-warning text-dark{% else %}bg-dark text-white{% endif %}">
                    <h3 class="mb-0">
                        <i class="bi bi-building"></i> Enterprise
                        {% if current_plan == 'ENTERPRISE' %}
                        <span class="badge bg-dark text-warning ms-2">Current</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="text-center mb-4">
                        <h1 class="display-3 fw-bold" id="enterprise-price">${{ plans.ENTERPRISE.price_monthly }}</h1>
                        <p class="text-muted" id="enterprise-period">per month</p>
                        <p class="small text-warning"><i class="bi bi-piggy-bank"></i> Save 17% with yearly billing</p>
                    </div>
                    <ul class="list-unstyled mb-4">
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>Unlimited</strong> QR Codes</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>Unlimited</strong> Storage</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> <strong>Unlimited</strong> API Calls</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Priority Support</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Custom Branding</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Advanced Analytics</li>
                    </ul>
                    <div class="mt-auto">
                        {% if current_plan != 'ENTERPRISE' %}
                        <form method="post" action="{% url 'upgrade_plan' %}" id="enterprise-form">
                            {% csrf_token %}
                            <input type="hidden" name="plan_type" value="ENTERPRISE">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Billing Cycle</label>
                                <select name="billing_cycle" class="form-select" id="enterprise-billing-select" onchange="updateEnterprisePrice(this.value)">
                                    <option value="monthly" selected>Monthly - ${{ plans.ENTERPRISE.price_monthly }}/mo</option>
                                    <option value="yearly">Yearly - ${{ plans.ENTERPRISE.price_yearly }}/yr (Save 17%)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-warning w-100 btn-lg">
                                <i class="bi bi-cart-check"></i> Proceed to Payment
                            </button>
                            <small class="d-block text-center text-muted mt-2">
                                <i class="bi bi-shield-check"></i> Secure checkout
                            </small>
                        </form>
                        {% else %}
                        <button class="btn btn-warning w-100" disabled>Current Plan</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Comparison Table -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="bi bi-list-check"></i> Feature Comparison</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th class="text-center">Free</th>
                                    <th class="text-center">Pro</th>
                                    <th class="text-center">Enterprise</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="bi bi-qr-code"></i> QR Codes</td>
                                    <td class="text-center">{{ plans.FREE.qr_limit }}</td>
                                    <td class="text-center">{{ plans.PRO.qr_limit }}</td>
                                    <td class="text-center">Unlimited</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-hdd"></i> Storage</td>
                                    <td class="text-center">{{ plans.FREE.storage_mb }}MB</td>
                                    <td class="text-center">{{ plans.PRO.storage_mb }}MB</td>
                                    <td class="text-center">Unlimited</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-code-slash"></i> API Calls/Day</td>
                                    <td class="text-center">{{ plans.FREE.api_calls_per_day }}</td>
                                    <td class="text-center">{{ plans.PRO.api_calls_per_day|floatformat:0 }}</td>
                                    <td class="text-center">Unlimited</td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-headset"></i> Priority Support</td>
                                    <td class="text-center"><i class="bi bi-x-lg text-danger"></i></td>
                                    <td class="text-center"><i class="bi bi-check-lg text-success"></i></td>
                                    <td class="text-center"><i class="bi bi-check-lg text-success"></i></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-palette"></i> Custom Branding</td>
                                    <td class="text-center"><i class="bi bi-x-lg text-danger"></i></td>
                                    <td class="text-center"><i class="bi bi-check-lg text-success"></i></td>
                                    <td class="text-center"><i class="bi bi-check-lg text-success"></i></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-graph-up"></i> Advanced Analytics</td>
                                    <td class="text-center"><i class="bi bi-x-lg text-danger"></i></td>
                                    <td class="text-center"><i class="bi bi-x-lg text-danger"></i></td>
                                    <td class="text-center"><i class="bi bi-check-lg text-success"></i></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.ribbon {
    position: absolute;
    right: -5px;
    top: -5px;
    z-index: 1;
    overflow: hidden;
    width: 75px;
    height: 75px;
    text-align: right;
}
.ribbon span {
    font-size: 10px;
    font-weight: bold;
    color: #FFF;
    text-transform: uppercase;
    text-align: center;
    line-height: 20px;
    transform: rotate(45deg);
    width: 100px;
    display: block;
    background: linear-gradient(#f70505 0%, #8f0808 100%);
    box-shadow: 0 3px 10px -5px rgba(0, 0, 0, 1);
    position: absolute;
    top: 19px;
    right: -21px;
}
</style>

<script>
// Price update functions for dynamic billing cycle changes
function updateProPrice(billingCycle) {
    const priceElement = document.getElementById('pro-price');
    const periodElement = document.getElementById('pro-period');
    
    if (billingCycle === 'yearly') {
        priceElement.textContent = '${{ plans.PRO.price_yearly }}';
        periodElement.textContent = 'per year';
    } else {
        priceElement.textContent = '${{ plans.PRO.price_monthly }}';
        periodElement.textContent = 'per month';
    }
    
    // Add animation
    priceElement.classList.add('animate__animated', 'animate__pulse');
    setTimeout(() => {
        priceElement.classList.remove('animate__animated', 'animate__pulse');
    }, 1000);
}

function updateEnterprisePrice(billingCycle) {
    const priceElement = document.getElementById('enterprise-price');
    const periodElement = document.getElementById('enterprise-period');
    
    if (billingCycle === 'yearly') {
        priceElement.textContent = '${{ plans.ENTERPRISE.price_yearly }}';
        periodElement.textContent = 'per year';
    } else {
        priceElement.textContent = '${{ plans.ENTERPRISE.price_monthly }}';
        periodElement.textContent = 'per month';
    }
    
    // Add animation
    priceElement.classList.add('animate__animated', 'animate__pulse');
    setTimeout(() => {
        priceElement.classList.remove('animate__animated', 'animate__pulse');
    }, 1000);
}

// Form submission confirmation
document.addEventListener('DOMContentLoaded', function() {
    const proForm = document.getElementById('pro-form');
    const enterpriseForm = document.getElementById('enterprise-form');
    
    if (proForm) {
        proForm.addEventListener('submit', function(e) {
            const billingCycle = document.getElementById('pro-billing-select').value;
            const price = billingCycle === 'yearly' ? '{{ plans.PRO.price_yearly }}' : '{{ plans.PRO.price_monthly }}';
            const period = billingCycle === 'yearly' ? 'year' : 'month';
            
            const confirmed = confirm(`Confirm upgrade to PRO plan?\n\nAmount: $${price}/${period}\nBilling: ${billingCycle}\n\nClick OK to proceed to payment.`);
            
            if (!confirmed) {
                e.preventDefault();
            }
        });
    }
    
    if (enterpriseForm) {
        enterpriseForm.addEventListener('submit', function(e) {
            const billingCycle = document.getElementById('enterprise-billing-select').value;
            const price = billingCycle === 'yearly' ? '{{ plans.ENTERPRISE.price_yearly }}' : '{{ plans.ENTERPRISE.price_monthly }}';
            const period = billingCycle === 'yearly' ? 'year' : 'month';
            
            const confirmed = confirm(`Confirm upgrade to ENTERPRISE plan?\n\nAmount: $${price}/${period}\nBilling: ${billingCycle}\n\nClick OK to proceed to payment.`);
            
            if (!confirmed) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
